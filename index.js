// Ø¬Ø¹Ù„ Ø§Ù„Ø§ÙƒØ³Ù„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø¹Ù…Ø¯Ø©
const TelegramBot = require('node-telegram-bot-api');
const ExcelJS = require('exceljs');
const express = require('express');
const mongoose = require('mongoose');
const fs = require('fs');
const path = require('path');
require('dotenv').config();

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ± Express
const app = express();
const port = process.env.PORT || 4000;

app.use(express.json()); // Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨ØªÙ†Ø³ÙŠÙ‚ JSON

app.get('/', (req, res) => {
    res.send('The server is running successfully.');
});

// Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
const token = process.env.TELEGRAM_BOT_TOKEN || '7742968603:AAFD-02grJl4Kt2V9b6Z-AxaCbwopEx_zZU';

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª
const bot = new TelegramBot(token, { polling: false });

const webhookUrl = process.env.WEBHOOK_URL || 'https://trygaz.onrender.com';
bot.setWebHook(`${webhookUrl}/bot${token}`);

app.post(`/bot${token}`, (req, res) => {
    bot.processUpdate(req.body);
    res.sendStatus(200);
});

// ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel
let data = [];
let adminState = {}; // Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„

// Ø§ØªØµØ§Ù„ MongoDB Atlas
const mongoURI = 'mongodb+srv://mrahel1993:7Am7dkIitbpVN9Oq@cluster0.rjekk.mongodb.net/userDB11?retryWrites=true&w=majority';
mongoose.connect(mongoURI, {
    useNewUrlParser: true,
    useUnifiedTopology: true,
})
    .then(() => console.log('Connected to MongoDB Atlas'))
    .catch(err => console.error('MongoDB connection error:', err));

// ØªØ¹Ø±ÙŠÙ Ù…Ø®Ø·Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ MongoDB
const userSchema = new mongoose.Schema({
    telegramId: { type: Number, required: true, unique: true },
    username: String,
    firstName: String,
    lastName: String,
    languageCode: String,
    bio: String,
    phoneNumber: String,
    isBot: Boolean,
    chatId: Number,
    joinedAt: { type: Date, default: Date.now },
});

const User = mongoose.model('User', userSchema);
/ Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„ÙØ§Øª Excel ÙÙŠ Ù…Ø¬Ù„Ø¯ Ù…Ø¹ÙŠÙ†
async function loadExcelFilesFromDirectory(directoryPath) {
    data = []; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©
    try {
        const files = fs.readdirSync(directoryPath);
        const excelFiles = files.filter(file => file.endsWith('.xlsx') || file.endsWith('.xls'));

        if (excelFiles.length === 0) {
            console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù„ÙØ§Øª Excel ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯.');
            sendMessageToAdmins("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù„ÙØ§Øª Excel ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯.");
            return;
        }

        for (const file of excelFiles) {
            const filePath = path.join(directoryPath, file);
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.readFile(filePath);
            const worksheet = workbook.worksheets[0];

            const fileStats = fs.statSync(filePath);
            const lastModifiedDate = fileStats.mtime.toISOString().split('T')[0];

            // Ù‚Ø±Ø§Ø¡Ø© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            const headers = worksheet.getRow(1).values;

            worksheet.eachRow((row, rowIndex) => {
                if (rowIndex === 1) return; // ØªØ®Ø·ÙŠ ØµÙ Ø§Ù„Ø±Ø¤ÙˆØ³
                const rowData = {};

                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø¤ÙˆØ³ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                headers.forEach((header, index) => {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ…Ø© Ù„Ù„Ø®Ù„ÙŠØ©
                    const value = row.getCell(index + 1).value?.toString().trim() || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
                    rowData[header] = value;
                });

                // Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…
                rowData['deliveryDate'] = lastModifiedDate;

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ©
                if (rowData['idNumber']) {
                    data.push(rowData);
                }
            });
        }

        console.log('ðŸ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Excel Ø¨Ù†Ø¬Ø§Ø­.');
        sendMessageToAdmins("ðŸ“¢ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Excel ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (error) {
        console.error('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„ÙØ§Øª Excel:', error.message);
        sendMessageToAdmins("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„ÙØ§Øª Excel.");
    }
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù…Ø¬Ù„Ø¯
const excelDirectory = path.join(__dirname, 'data'); // Ø§Ø³ØªØ¨Ø¯Ù„ 'data' Ø¨Ù…Ø³Ø§Ø± Ù…Ø¬Ù„Ø¯Ùƒ
loadExcelFilesFromDirectory(excelDirectory);

// Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
const adminIds = process.env.ADMIN_IDS?.split(',') || ['7719756994'];

// Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;

    const options = {
        reply_markup: {
            keyboard: [
                [{ text: "ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…" }],
                [{ text: "ðŸ“ž Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„" }, { text: "ðŸ“– Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª" }],
            ],
            resize_keyboard: true,
            one_time_keyboard: false,
        },
    };

    if (adminIds.includes(chatId.toString())) {
        options.reply_markup.keyboard.push([{ text: "ðŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹" }]);
    }

    bot.sendMessage(chatId, "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:", options);
});

// Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø¨Ø­Ø«
bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    const input = msg.text.trim();

    if (input === '/start' || input.startsWith('/')) return;

    if (input === "ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…") {
        bot.sendMessage(chatId, "ðŸ“ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¨Ø­Ø«:");
    } else if (input === "ðŸ“ž Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„") {
        const contactMessage = `
ðŸ“ž **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:**
Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¯Ø¹Ù… Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±
ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø±:
ðŸ’¬ ØªÙ„Ø¬Ø±Ø§Ù…: [https://t.me/AhmedGarqoud]
        `;
        bot.sendMessage(chatId, contactMessage, { parse_mode: 'Markdown' });
    } else if (input === "ðŸ“– Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª") {
        const aboutMessage = `
ðŸ¤– **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª:**
Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØªÙŠØ­ Ù„Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…Ùƒ ÙÙŠ ÙƒØ´ÙˆÙØ§Øª Ø§Ù„ØºØ§Ø² Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ø³Ù…Ùƒ ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø³Ø¬Ù„ ÙÙŠ ÙƒØ´ÙˆÙØ§Øª Ø§Ù„ØºØ§Ø².
ðŸ”§ **Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©**: ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø¨ÙˆØ§Ø³Ø·Ø© [Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯].
        `;
        bot.sendMessage(chatId, aboutMessage, { parse_mode: 'Markdown' });
    } else if (input === "ðŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹" && adminIds.includes(chatId.toString())) {
        adminState[chatId] = 'awaiting_broadcast_message';
        bot.sendMessage(chatId, "âœ‰ï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø±Ø³Ø§Ù„:");
    } else if (adminState[chatId] === 'awaiting_broadcast_message') {
        delete adminState[chatId]; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        await sendBroadcastMessage(input, chatId);
    } else {
        const user = data.find((entry) => entry.idNumber === input || entry.name === input);

        if (user) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            let response = "ðŸ” **ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:**\n\n";
            for (const [key, value] of Object.entries(user)) {
                // ØªØ­ÙˆÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¥Ù„Ù‰ Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…ÙÙ‡ÙˆÙ…Ø©
                const formattedKey = key
                    .replace(/([A-Z])/g, ' $1') // Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
                    .replace(/^./, str => str.toUpperCase()); // ØªØ­ÙˆÙŠÙ„ Ø£ÙˆÙ„ Ø­Ø±Ù Ø¥Ù„Ù‰ ÙƒØ¨ÙŠØ±
                response += `**${formattedKey}**: ${value || "ØºÙŠØ± Ù…ØªÙˆÙØ±"}\n`;
            }

            bot.sendMessage(chatId, response, { parse_mode: 'Markdown' });
        } else {
            bot.sendMessage(chatId, "âš ï¸ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø¯Ø®Ù„ Ø§Ù„Ù…Ù‚Ø¯Ù….");
        }
    }

    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ MongoDB
    const userData = {
        telegramId: msg.from.id,
        username: msg.from.username || "No Username",
        firstName: msg.from.first_name || "No First Name",
        lastName: msg.from.last_name || "No Last Name",
        languageCode: msg.from.language_code || "en",
        bio: msg.from.bio || "No Bio",
        phoneNumber: msg.contact ? msg.contact.phone_number : null,
        isBot: msg.from.is_bot,
        chatId: msg.chat.id,
    };

    try {
        let user = await User.findOne({ telegramId: msg.from.id });
        if (!user) {
            user = new User(userData);
            await user.save();
            console.log(`User ${msg.from.id} saved to database.`);
        } else {
            console.log(`User ${msg.from.id} already exists.`);
        }
    } catch (err) {
        console.error('Error saving user to database:', err);
    }
});

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
async function sendBroadcastMessage(message, adminChatId) {
    try {
        // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const users = await User.find({});

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
        for (const user of users) {
            try {
                await bot.sendMessage(user.telegramId, message);
            } catch (err) {
                console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user.telegramId}:`, err.message);
            }
        }

        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„
        bot.sendMessage(adminChatId, "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­.");
    } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err.message);
        bot.sendMessage(adminChatId, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.");
    }
}

// Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
function sendMessageToAdmins(message) {
    adminIds.forEach(adminId => {
        bot.sendMessage(adminId, message);
    });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
app.listen(port, () => {
    console.log(`Server is running on port ${port}`);
});
